如申请号 SOH201701060005 
引用有 价差单 1，2，3
删除了明细2 修改了明细1

这个张单有哪些价差单

前台传进来一组数据
有明细被删除的 有明细被修改的

传进来的就只有被修改的明细数据。

要更新价差单维护表里的占用金额

多条订单明细
多条价差单明细

SO00_1
SO00_2
                                                            分摊
JC001 剩余金额   500    300
JC002 剩余金额    1000   300

优先分摊完可以分摊的价差单

价差单：
客户 -> 美芝  （ 正数） 客户欠钱   高开
客户 -> 美芝  （ 负数） 欠客户钱   低开

SO001   1.2    300  360
SO002   1.9    200  380

jc001  800
jc002  200

确认一条明细
    可以核销一条明细

实际分摊金额 》 计划分摊金额 

仓库确认    核销：
    单条明细确认时：   实发数×单台价差  = 这个出货通知书号 实际分摊金额

1. 实际分摊金额 和 列表中第一个价差单的分摊剩余金额进行比较 （分摊剩余金额 = 分摊金额 - 实际分摊金额 ）
    如果 实际分摊金额小于，等于 分摊剩余金额：
      1.写进价差总表
         diff_amount_id， 已核销金额 = 已核销金额+实际分摊金额        占用金额= 占用金额 - 实际分摊金额

      2.写进明细表
         diff_id,本次实际分摊金额 += 实际分摊金额
      实际分摊金额=0
      break
      
    实际分摊金额大于分摊剩余金额            
      1.写进价差总表               
        diff_amount_id,已核销金额 +=分摊剩余金额    占用金额-=分摊剩余金额
      2.写进明细表
        diff_id, 本次实际分摊金额+= 分摊剩余金额
      实际分摊金额 = 实际分摊金额 - 分摊剩余金额  

最后一张单时释放掉这张单所有的价差明细的剩余占用金额          
    剩余占用金额 = 本次计划分摊金额-本次实际分摊金额
    
    占用金额-=剩余占用金额
 bill_type ==1 
    剩余金额+=剩余占用金额
 else   
    剩余金额 -=剩余占用金额
    
    //TODO
 前台验证

1.所引入的价差单bill_type要一致
2.输入的计划分摊金额>0  
3.每一条明细的本次计划分摊金额 小于等于剩余金额
4.引入的价差单与出货通知书的币种要一致

